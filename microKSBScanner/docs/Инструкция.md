# Сканнер

Сканнер состоит из двух частей: серверной части и клиентской. Серверная часть является агентом для Сервиса Интеграций.
Клиентскую часть нужно положить в айтиконнектор чтобы он вшивал в название файла айди клиента и адрес серверной части и
позволял её скачивать клиенту. Так же клиентскую часть нужно положить рядом с развернутой серверной частью для
автообновления клиентских частей. Обовсёмэтомподробнеениже.

## Сборка

Требования к машине:

1. Установить `docker`

### Ручная

#### Первый раз

1. Клонируем проект.

    ```bash
    $> git clone https://ksb-dev.keysystems.local/intgrsrv/microKSBScanner.git && cd microKSBScanner
    ```

1. Переключаемся на нужную ветку

    ```bash
    $> git checkout inventory
    ```

#### Продолжение первого и при последующих разах

1. Подтянем изменения с сервера

    ```bash
    $> git pull
    ```

1. Соберём
    - серверную часть

        ```bash
        $> make build PROJECTNAME=microKSBScanner VERSION=0.2.1
        ```

    - клиентскую часть

        ```bash
        $> make build PROJECTNAME=KSBAgent VERSION=0.2.1
        ```

   Где `0.2.1` номер собираемой версии (semver), просто вшивается в сервис насколько я помню. Учёт в ручном режиме
   ручной. Версии для серверной части и клиентской должны быть одинаковыми. Если будут ошибки при сборке, то писать
   Шайкину Андрею - он правил докер файл.

1. Появится каталог `.builded` в котором будут собранные файлы под Linux и Windows.

### Автоматическая

Тут надо уточнить у Шайкина Андрея. Он что-то делал в этом направлении.

## Разворачивание

### Ручное

Клиентские части нужно передать в айтиконнектор. Серверную часть по пунктам ниже.

#### Первый раз

1. После сборки в ручном режиме переносим файл `.builded/.../microKSBScanner` в каталог `/opt/microKSBScanner`
   необходимой машины.
1. Каждую клиентскую часть `.builded/.../KSBAgent`,`.builded/.../KSBAgent` (можно для архива переименовать в
   просто `ksbagent`,`ksbagent.exe`) для линукса и винды отдельно архивируем в архивы с названием
   вида `ksbagent_0.2.1_linux.zip`,`ksbagent_0.2.1_windows.zip` и кладём в каталог `/opt/microKSBScanner/agentzip`
1. Копируем в каталог `/etc/systemd/system` файл проекта `build/microKSBScanner.service`
1. В консоли включаем и стартуем агента:

    ```bash
    $> systemctl enable microKSBScanner.service
    $> systemctl start microKSBScanner.service
    $> systemctl status microKSBScanner.service
    ```

#### Обновление ранее развёрнутого

1. Останавливаем сервис

    ```bash
    $> systemctl stop microKSBScanner.service
    ```

1. Выполняем первый и второй пункты из `Первый раз`
1. Стартуем сервис

    ```bash
    $> systemctl start microKSBScanner.service
    ```

## Дополнение

### Папка deprecated

+ KSBAgent - самая старая реализация;
+ inventoryAgent - при открытии собирает данные, отправляет и закрывается;

### Требование к файлу:

Айтиконнектору генерировать для клиента название файла в виде `ksbagent_81fb3e6c54c44f728c9d84c864a96b7b_localhost_3004`
. Для винды `.exe` в конце. А отдавать соответствующую ОС бабушки версию. Где:

- `81fb3e6c54c44f728c9d84c864a96b7b` - guid без минусов. Это индентификатор клиента-бабушки, для каждой свой.
- `localhost` - адрес машины где установлена и запущена серверная часть сканера `microKSBScanner`.
- `3004` - порт по которому слушает серверная часть сканера.

Нужно написать инсталляторы клиенсткой части для винды и линукса для установки в качестве сервисов.
